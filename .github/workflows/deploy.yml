name: Deploy to Production

on:
  workflow_dispatch:
  push:
    tags: ['v*']

env:
  PYTHON_VERSION: "3.12"
  NODE_VERSION: "20"

jobs:
  deploy-backend:
    name: Deploy Backend to Railway
    runs-on: ubuntu-latest
    environment: production
    steps:
      - uses: actions/checkout@v4

      - name: Install Railway CLI
        run: npm install -g @railway/cli

      - name: Deploy to Railway
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
        run: |
          cd backend
          railway up --service bonito-backend --detach

      - name: Health Check
        run: |
          echo "Waiting for deployment to stabilize..."
          sleep 30
          for i in 1 2 3 4 5; do
            STATUS=$(curl -s -o /dev/null -w "%{http_code}" "${{ vars.RAILWAY_BACKEND_URL }}/api/health" || echo "000")
            if [ "$STATUS" = "200" ]; then
              echo "‚úÖ Backend healthy (attempt $i)"
              exit 0
            fi
            echo "‚è≥ Attempt $i: got $STATUS, retrying in 15s..."
            sleep 15
          done
          echo "‚ùå Backend health check failed"
          exit 1

  deploy-frontend:
    name: Deploy Frontend to Vercel
    runs-on: ubuntu-latest
    environment: production
    steps:
      - uses: actions/checkout@v4

      - name: Deploy to Vercel
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
        run: |
          npm install -g vercel
          cd frontend
          vercel --prod --token=$VERCEL_TOKEN --yes

  post-deploy:
    name: Post-Deploy Smoke Tests
    runs-on: ubuntu-latest
    needs: [deploy-backend, deploy-frontend]
    steps:
      - uses: actions/checkout@v4

      - name: Wait for deployments to stabilize
        run: sleep 15

      - name: Health checks
        run: |
          echo "üêü Running post-deploy smoke tests..."
          BACKEND="${{ vars.RAILWAY_BACKEND_URL }}"
          FRONTEND="${{ vars.VERCEL_FRONTEND_URL }}"
          FAIL=0

          check() {
            local label="$1" url="$2" expected="$3"
            STATUS=$(curl -s -o /dev/null -w "%{http_code}" "$url" --max-time 15 || echo "000")
            if [ "$STATUS" = "$expected" ]; then
              echo "  ‚úì $label ($STATUS)"
            else
              echo "  ‚úó $label (got $STATUS, expected $expected)"
              FAIL=$((FAIL+1))
            fi
          }

          echo "‚îÅ‚îÅ‚îÅ Backend Health ‚îÅ‚îÅ‚îÅ"
          check "API health"       "$BACKEND/api/health"       200
          check "Liveness probe"   "$BACKEND/api/health/live"  200
          check "Readiness probe"  "$BACKEND/api/health/ready" 200

          echo "‚îÅ‚îÅ‚îÅ Frontend ‚îÅ‚îÅ‚îÅ"
          check "Homepage"         "$FRONTEND"                 200
          check "Login page"       "$FRONTEND/login"           200
          check "Register page"    "$FRONTEND/register"        200

          echo "‚îÅ‚îÅ‚îÅ Auth API ‚îÅ‚îÅ‚îÅ"
          check "Bad login rejected" "$BACKEND/api/auth/login" 405  # GET should be method not allowed
          REG_STATUS=$(curl -s -o /dev/null -w "%{http_code}" -X POST "$BACKEND/api/auth/login" \
            -H "Content-Type: application/json" \
            -d '{"email":"smoke@test.dev","password":"WrongPass1"}' --max-time 10 || echo "000")
          if [ "$REG_STATUS" = "401" ]; then
            echo "  ‚úì Invalid login returns 401"
          else
            echo "  ‚úó Invalid login returned $REG_STATUS (expected 401)"
            FAIL=$((FAIL+1))
          fi

          echo "‚îÅ‚îÅ‚îÅ Protected endpoints (no auth) ‚îÅ‚îÅ‚îÅ"
          check "Providers (401)"  "$BACKEND/api/providers/"   401
          check "Models (401)"     "$BACKEND/api/models/"      401

          echo ""
          if [ $FAIL -eq 0 ]; then
            echo "üêü All smoke tests passed!"
          else
            echo "‚ö† $FAIL smoke test(s) failed"
            exit 1
          fi

      - name: Run full API tests (if credentials available)
        if: ${{ vars.SMOKE_TEST_EMAIL != '' }}
        run: |
          chmod +x scripts/test-api.sh
          API_BASE="${{ vars.RAILWAY_BACKEND_URL }}" \
          ./scripts/test-api.sh \
            "${{ vars.VERCEL_FRONTEND_URL }}" \
            "${{ vars.SMOKE_TEST_EMAIL }}" \
            "${{ secrets.SMOKE_TEST_PASSWORD }}"
